// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Story {
  id            String     @id @default(uuid()) @db.Uuid
  title         String?
  prompt        String?
  age           Decimal?   @db.Decimal(3, 1)
  createdAt     DateTime   @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime   @default(now()) @map("updated_at") @db.Timestamptz
  audioPath     String?    @map("audio_path")
  featured      Boolean    @default(false)
  summary       String?
  coverUrl      String?    @map("cover_url")
  voiceSettings Json?      @map("voice_settings")
  systemPrompt  String?    @map("system_prompt")
  status          String     @default("requested")
  requesterName   String?    @map("requester_name")
  requesterSource String?    @map("requester_source")
  requesterContact String?   @map("requester_contact")
  interests       String?
  heroName        String?    @map("hero_name") @db.VarChar(100)
  testGroup       String?    @map("test_group") @db.VarChar(1)
  scriptData      Json?      @map("script_data")
  durationSeconds Int?       @map("duration_seconds")
  characters      Character[]
  lines         Line[]
  plays         Play[]
  costs         Cost[]

  @@map("stories")
}

model Cost {
  id             Int      @id @default(autoincrement())
  storyId        String?  @map("story_id") @db.Uuid
  service        String   @db.VarChar(20)
  operation      String   @db.VarChar(30)
  inputTokens    Int?     @map("input_tokens")
  outputTokens   Int?     @map("output_tokens")
  thinkingTokens Int?     @map("thinking_tokens")
  characters     Int?
  costUsd        Decimal? @map("cost_usd") @db.Decimal(10, 6)
  metadata       Json?
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz
  story          Story?   @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@index([storyId])
  @@map("costs")
}

model Play {
  id        Int      @id @default(autoincrement())
  storyId   String   @map("story_id") @db.Uuid
  playedAt  DateTime @default(now()) @map("played_at") @db.Timestamptz
  userAgent String?  @map("user_agent")
  ip        String?
  completed Boolean  @default(false)
  story     Story    @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@index([storyId])
  @@map("plays")
}

model Character {
  id      Int     @id @default(autoincrement())
  storyId String  @map("story_id") @db.Uuid
  name    String?
  gender  String?
  voiceId String? @map("voice_id")
  emoji       String?
  description String?
  story       Story   @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@index([storyId])
  @@map("characters")
}

model Line {
  id        Int     @id @default(autoincrement())
  storyId   String  @map("story_id") @db.Uuid
  sceneIdx  Int?    @map("scene_idx")
  lineIdx   Int?    @map("line_idx")
  speaker   String?
  text      String?
  sfx       String?
  audioPath String? @map("audio_path")
  story     Story   @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@index([storyId])
  @@map("lines")
}

// waitlist table removed